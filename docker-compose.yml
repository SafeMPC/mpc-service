# 定义共享的环境变量值（使用 x- 扩展字段）
x-common-vars: &common-vars
  PGDATABASE: "mpc-dev-db"
  PGUSER: "dbuser"
  PGPASSWORD: "dbpass"
  PGHOST: "postgres"
  PGPORT: "5432"
  PGSSLMODE: "disable"
  PROJECT_ROOT_DIR: "/app"

services:
  # ============================================
  # MPC Service 节点（会话管理/协调，不参与计算）
  # ============================================
  mpc-service:
    build:
      context: .
      target: development
    ports:
      - "8080:8080"  # HTTP API
      - "9090:9090"  # gRPC
      - "9094:9094"  # Infra gRPC
    working_dir: /app
    user: development
    volumes:
      - .:/app:delegated
      - go-pkg:/go/pkg
      - workdir-api-tmp:/app/api/tmp
      - workdir-bin:/app/bin
      - workdir-tmp:/app/tmp
      - vscode-extensions:/home/development/.vscode-server/extensions
      - vscode-extensions-insiders:/home/development/.vscode-server-insiders/extensions
      - bash-history:/home/development/commandhistory
      - mpc-service-key-shares:/app/var/lib/mpc/key-shares
    depends_on:
      postgres:
        condition: service_healthy
      consul:
        condition: service_started
      redis:
        condition: service_started
    environment:
      # Database configuration
      <<: *common-vars
      PSQL_DBNAME: "spec"
      PSQL_USER: "dbuser"
      PSQL_PASS: "dbpass"
      PSQL_HOST: "postgres"
      PSQL_PORT: "5432"
      PSQL_SSLMODE: "disable"
      SERVER_LOGGER_PRETTY_PRINT_CONSOLE: "true"
      SERVER_MANAGEMENT_SECRET: "mgmtpass"
      CHANGIE_CONFIG_PATH: "/app/.changie-go-starter.yaml"
      # MPC Service configuration
      MPC_NODE_TYPE: "service"
      MPC_NODE_ID: "mpc-service-1"
      MPC_CONSUL_ADDRESS: "consul:8500"
      MPC_REGISTER_ADDRESS: "192.168.111.183"
      MPC_STORAGE_BACKEND: "postgresql"
      MPC_REDIS_ENDPOINT: "redis:6379"
      MPC_KEY_SHARE_STORAGE_PATH: "/app/var/lib/mpc/key-shares"
      MPC_KEY_SHARE_ENCRYPTION_KEY: "your-encryption-key-here-change-in-production"
      MPC_SUPPORTED_PROTOCOLS: "gg18,gg20,frost"
      MPC_DEFAULT_PROTOCOL: "frost"
      SERVER_ECHO_LISTEN_ADDRESS: ":8080"
      SERVER_ECHO_BASE_URL: "http://mpc-service:8080"
      MPC_HTTP_PORT: "8080"
      MPC_GRPC_PORT: "9090"
      MPC_INFRA_GRPC_PORT: "9094"
      MPC_TLS_ENABLED: "false"
      MPC_TLS_CERT_FILE: "/app/certs/client.crt"
      MPC_TLS_KEY_FILE: "/app/certs/client.key"
      MPC_TLS_CA_CERT_FILE: "/app/certs/ca.crt"
      MPC_ENABLE_AUDIT: "true"
      MPC_ENABLE_POLICY: "true"
      MPC_KEY_ROTATION_DAYS: "0"
      MPC_MAX_CONCURRENT_SESSIONS: "100"
      MPC_MAX_CONCURRENT_SIGNINGS: "50"
      MPC_SESSION_TIMEOUT: "300"
    cap_add:
      - SYS_PTRACE
    security_opt:
      - seccomp:unconfined
    # Overrides default command so things don't shut down after the process ends.
    command:
      - /bin/sh
      - -c
      - |
        sudo chown -R development:development /app/api/tmp
        sudo chown -R development:development /app/bin
        sudo chown -R development:development /app/tmp
        chmod +x /app/rksh
        git config --global --add safe.directory /app
        # 首次启动需要构建
        if [ ! -f /app/bin/app ]; then
          echo "Building application..."
          cd /app && make build
        fi
        # 启动应用，如果失败则保持容器运行
        /app/bin/app server || while sleep 1000; do :; done


    healthcheck:
      test: ["CMD", "curl", "-f", "-s", "http://localhost:8080/-/healthy?mgmt-secret=mgmtpass"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s
    extra_hosts:
      - "host.docker.internal:host-gateway"  # 允许访问宿主机服务（用于连接 Signer）

  # ============================================
  # 注意：根据 2-of-2 架构设计
  # - mpc-service: 会话管理/协调节点（本服务）
  # - server-signer-p2: 执行 MPC 协议计算的节点（在 mpc-signer 目录中）
  # - 手机端 P1: 通过移动端 SDK 作为 Signer 节点
  # 
  # 以下节点已移除（2-of-2 模式不需要）：
  # - server-proxy-1, server-proxy-2, server-backup-1
  # ============================================

  # ============================================
  # 基础设施服务
  # ============================================

  postgres:
    image: postgres:17.4-alpine
    # ATTENTION: These settings are for development only!
    # NEVER use fsync=off, synchronous_commit=off, full_page_writes=off in PRODUCTION
    command: "postgres -c 'shared_buffers=128MB' -c 'fsync=off' -c 'synchronous_commit=off' -c 'full_page_writes=off' -c 'max_connections=100' -c 'client_min_messages=warning'"
    expose:
      - "5432"
    ports:
      - "5432:5432"
    environment:
      POSTGRES_DB: "mpc-dev-db"
      POSTGRES_USER: "dbuser"
      POSTGRES_PASSWORD: "dbpass"
    volumes:
      - pgvolume:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $${POSTGRES_USER} -d $${POSTGRES_DB}"]
      interval: 5s
      timeout: 5s
      retries: 5
      start_period: 10s

  integresql:
    image: ghcr.io/allaboutapps/integresql:v1.1.0
    expose:
      - "5000"
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      PGHOST: "postgres"
      PGUSER: "dbuser"
      PGPASSWORD: "dbpass"

  mailhog:
    image: mailhog/mailhog
    expose:
      - "1025"
    ports:
      - "8025:8025"

  swaggerui:
    image: swaggerapi/swagger-ui:v3.46.0
    environment:
      SWAGGER_JSON: "/api/swagger.yml"
    volumes:
      - ./api:/api:ro,consistent
      - ./api/config/swagger-ui-local-translator.js:/usr/share/nginx/configurator/translator.js:ro,delegated

  swaggerui-browser-sync:
    image: allaboutapps/browser-sync:v2.26.14
    command: start --proxy 'swaggerui:8080' --port 8081 --files "/api/*.yml"
    volumes:
      - ./api:/api:ro,consistent
    ports:
      - "8091:8081"  # Swagger UI Browser Sync 端口

  consul:
    image: consul:1.15
    ports:
      - "8500:8500"
      - "8600:8600/udp"
    command: "agent -server -bootstrap-expect=1 -ui -client=0.0.0.0 -log-level=info"
    volumes:
      - consul-data:/consul/data
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8500/v1/status/leader"]
      interval: 10s
      timeout: 5s
      retries: 3

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    command: redis-server --appendonly yes
    volumes:
      - redis-data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5

volumes:
  # PostgreSQL data persistence
  pgvolume:

  # Consul data persistence
  consul-data:

  # Redis data persistence
  redis-data:

  # Go module cache
  go-pkg:

  # Temporary directories
  workdir-api-tmp:
  workdir-bin:
  workdir-tmp:

  # VSCode extensions cache
  vscode-extensions:
  vscode-extensions-insiders:

  # Bash history
  bash-history:

  # MPC key shares storage (每个节点独立的存储卷，确保密钥分片隔离)
  mpc-service-key-shares:
